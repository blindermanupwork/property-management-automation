# Service Line Auto-Update System

## Overview
Automated system to keep HCP service line descriptions synchronized with Airtable changes. Uses a pipe-separated format to preserve manual notes while auto-updating service information.

## Features
- **Real-time Updates**: Webhook triggers when Service Line Description changes in Airtable
- **Manual Notes Preservation**: Format: `"Manual notes | Auto-generated service line"`
- **Safety First**: Currently limited to "Boris Blinderman Test Property" for testing
- **Smart Updates**: Only calls HCP API when content actually changes

## Architecture

### Components
1. **Airtable Automation Script** (`update-hcp-service-line.js`)
   - Triggered when Service Line Description field changes
   - Sends webhook to servativ API with all necessary data
   - Updates "Last Synced Service Line" field on success

2. **API Webhook Handler** (`routes/automation.js`)
   - Endpoint: `/api/prod/automation/update-service-line`
   - Fetches current HCP line item
   - Preserves manual notes before pipe separator
   - Updates HCP via API

### Data Flow
```
Airtable Field Change → Automation Trigger → Webhook to API → HCP Update → Airtable Sync Status
```

## Format Examples

### Scenario 1: Manual Notes Exist
- **Current HCP**: `"BRING EXTRA TOWELS"`
- **New Service Line**: `"Turnover STR Next Guest July 5"`
- **Result**: `"BRING EXTRA TOWELS | Turnover STR Next Guest July 5"`

### Scenario 2: Already Has Pipe
- **Current HCP**: `"BRING TOWELS | Turnover STR Next Guest July 3"`
- **New Service Line**: `"Turnover STR Next Guest July 5"`
- **Result**: `"BRING TOWELS | Turnover STR Next Guest July 5"`

### Scenario 3: Empty Line Item
- **Current HCP**: (empty)
- **New Service Line**: `"SAME DAY Turnover STR"`
- **Result**: `"SAME DAY Turnover STR"`

## Configuration

### Airtable Fields Required
- `Service Line Description` - Auto-generated by existing automation
- `Last Synced Service Line` - Long text field to track sync status
- `Service Job ID` - HCP job identifier

### API Authentication
- Uses standard API key: `airscripts-secure-key-2025`
- Required header: `X-API-Key`

## Implementation Status
- ✅ Webhook handler implemented
- ✅ Airtable script created
- ✅ Pipe separator logic working
- ✅ Character limit handling (200 chars for HCP)
- ✅ Test property validation
- ⏳ Awaiting expansion to all properties

## Future Enhancements
1. Expand beyond test property after validation
2. Add batch processing for multiple updates
3. Implement retry logic for failed updates
4. Add detailed sync history tracking