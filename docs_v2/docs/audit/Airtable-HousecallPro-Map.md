# Airtable-HousecallPro-Map.md - Complete Integration Mapping

## Overview
This document provides complete object, field, and automation mapping between Airtable and HousecallPro, including all MCP (Model Context Protocol) integrations for Claude AI assistance.

## Environment-Specific Configurations

### Development Environment
- **Airtable Base ID**: `app67yWFv0hKdl6jM`
- **HCP MCP Server**: `hcp-mcp-dev`
- **Airtable MCP Server**: `airtable-dev`
- **API Endpoints**: Development/Sandbox HCP instance

### Production Environment
- **Airtable Base ID**: `appZzebEIqCU5R9ER`
- **HCP MCP Server**: `hcp-mcp-prod`
- **Airtable MCP Server**: `airtable-prod`
- **API Endpoints**: Production HCP instance

## Core Object Mappings

### Customer Data Mapping

#### Airtable "Reservations" → HCP Customer
| Airtable Field | HCP Customer Field | Mapping Logic | Data Type |
|---|---|---|---|
| Guest Name | first_name + last_name | Split on first space | String |
| Phone | mobile_number | Direct mapping | String |
| Email | email | Direct mapping | String |
| - | id | Generated by HCP | String (cus_xxxxxxx) |

**MCP Operations**:
- `get_customer(customer_id)` - Retrieve customer details
- `create_customer(first_name, last_name, email, mobile_number)` - Create new customer
- `update_customer(customer_id, ...)` - Update existing customer
- `list_customers(q="search_term")` - Search customers

#### Address Data Mapping

#### Airtable "Reservations" → HCP Address (within Customer)
| Airtable Field | HCP Address Field | Mapping Logic | Data Type |
|---|---|---|---|
| Address Line 1 | street | Direct mapping | String |
| Address Line 2 | street_line_2 | Direct mapping | String |
| City | city | Direct mapping | String |
| State | state | Direct mapping | String |
| Zip | zip | Direct mapping | String |
| - | id | Generated by HCP | String (adr_xxxxxxx) |
| - | type | Default: "service" | String |

**MCP Operations**:
- `search_addresses(street="...", city="...", customer_id="...")` - Find addresses
- `get_jobs_by_address(address_id, work_status="...")` - Get jobs for address

### Job Data Mapping

#### Airtable "Reservations" → HCP Job
| Airtable Field | HCP Job Field | Mapping Logic | Data Type |
|---|---|---|---|
| HCP Job ID | id | Direct mapping (stored in Airtable) | String (job_xxxxxxx) |
| HCP Customer ID | customer_id | Direct mapping | String (cus_xxxxxxx) |
| Service Date + Service Time | scheduled_start | Combined and converted to ISO 8601 | DateTime |
| Service Date + Service Time + Duration | scheduled_end | Calculated (start + 2 hours default) | DateTime |
| Status | work_status | Mapped via status translation | Enum |
| Notes | notes | Direct mapping | String |
| Property Name + Service Type | description | Combined with template | String |
| Assigned Employee | assigned_employee_ids | Array mapping | Array[String] |

**Status Translation Mapping**:
| Airtable Status | HCP work_status | Business Meaning |
|---|---|---|
| New | - | Not yet created in HCP |
| Processing | - | Being processed for HCP creation |
| Job Created | unscheduled | Created but not scheduled |
| Scheduled | scheduled | Scheduled with time/employee |
| In Progress | in_progress | Employee has started work |
| Completed | completed | Work finished |
| Cancelled | canceled | Job cancelled |

**MCP Operations**:
- `list_jobs(customer_id="...", work_status="...", per_page=100)` - List jobs with filters
- `get_job(job_id)` - Get specific job details
- `create_job(customer_id, address_id, schedule={...})` - Create new job
- `update_job(job_id, work_status="...", ...)` - Update job
- `reschedule_job(job_id, schedule={...})` - Reschedule existing job

### Line Item Data Mapping

#### Airtable Service Configuration → HCP Line Items
| Airtable Field | HCP Line Item Field | Mapping Logic | Data Type |
|---|---|---|---|
| Service Line Custom Instructions | name | "Cleaning Service - [Instructions]" | String (200 char limit) |
| - | unit_price | From configuration/rate table | Number |
| - | quantity | Default: 1 | Number |
| - | kind | Default: "service" | Enum |
| - | taxable | From configuration (default: true) | Boolean |
| - | id | Generated by HCP | String (li_xxxxxxx) |

**MCP Operations**:
- `get_job_line_items(job_id)` - Get all line items for job
- `create_job_line_item(job_id, name, unit_price, quantity, kind)` - Add line item
- `update_job_line_item(job_id, line_item_id, ...)` - Update line item
- `delete_job_line_item(job_id, line_item_id)` - Remove line item
- `update_job_line_items(job_id, line_items=[...])` - Bulk update

## Bidirectional Sync Mappings

### HCP → Airtable Updates (Webhook-Driven)

#### Job Status Changes
**Webhook Event**: Job status updated in HCP
**Airtable Update**: Status field updated
**Mapping Logic**:
```javascript
hcp_status_to_airtable = {
  "scheduled": "Scheduled",
  "in_progress": "In Progress", 
  "completed": "Completed",
  "canceled": "Cancelled"
}
```

#### Employee Assignment Changes
**Webhook Event**: Employee assigned/unassigned in HCP
**Airtable Update**: Assigned Employee field updated
**Mapping Logic**: Employee ID → Employee Name lookup

#### Schedule Changes
**Webhook Event**: Job reschedule in HCP
**Airtable Updates**:
- Scheduled Start → scheduled_start
- Scheduled End → scheduled_end
- Custom Service Time → extracted time component

### Airtable → HCP Updates (Button-Triggered)

#### Service Time Updates
**Button**: "Add/Update Schedule"
**HCP API Call**: `reschedule_job()`
**Mapping Logic**:
- Custom Service Time (if set) OR Service Time → scheduled_start
- scheduled_end = scheduled_start + service_duration

#### Job Creation
**Button**: "Create Job & Sync Status"
**HCP API Calls**: 
1. `create_customer()` (if needed)
2. `create_job()`
3. `create_job_line_item()`
**Mapping**: Full object creation with all field mappings

## MCP Server Integration Architecture

### Airtable MCP Server (`airtable-mcp-server`)

#### Available Tools
| MCP Tool | Purpose | Parameters |
|---|---|---|
| `list_records` | Get records from table | baseId, tableId, maxRecords, filterByFormula |
| `search_records` | Search within table | baseId, tableId, searchTerm |
| `get_record` | Get specific record | baseId, tableId, recordId |
| `create_record` | Create new record | baseId, tableId, fields |
| `update_records` | Update existing records | baseId, tableId, records |
| `delete_records` | Delete records | baseId, tableId, recordIds |

#### Table Mappings
| Business Entity | Airtable Table ID | Primary Fields |
|---|---|---|
| Reservations | tblXXXXXXXXXXXXXX | Reservation UID, Guest Name, Service Date |
| Properties | tblYYYYYYYYYYYYYY | Property Name, Address, Management Company |
| Automation Settings | tblZZZZZZZZZZZZZZ | Setting Name, Setting Value, Environment |

### HCP MCP Server (`hcp-mcp-dev` / `hcp-mcp-prod`)

#### Core CRUD Operations
| MCP Tool | HCP API Endpoint | Purpose |
|---|---|---|
| `list_customers` | GET /customers | List/search customers |
| `get_customer` | GET /customers/{id} | Get customer details |
| `create_customer` | POST /customers | Create new customer |
| `update_customer` | PUT /customers/{id} | Update customer |
| `list_jobs` | GET /jobs | List/search jobs |
| `get_job` | GET /jobs/{id} | Get job details |
| `create_job` | POST /jobs | Create new job |
| `update_job` | PUT /jobs/{id} | Update job |
| `reschedule_job` | PUT /jobs/{id}/reschedule | Reschedule job |

#### Enhanced Search Tools (v2.2.1+)
| MCP Tool | Purpose | Use Cases |
|---|---|---|
| `search_addresses` | Find addresses across customers | Address validation, duplicate detection |
| `get_jobs_by_address` | Get jobs for specific address | Property history, recurring services |
| `list_employees` | Get employee list | Assignment options, scheduling |
| `get_employee_schedule` | Employee availability | Conflict checking, optimization |

#### Analysis Tools (v2.2.1+)
| MCP Tool | Purpose | Business Value |
|---|---|---|
| `analyze_laundry_jobs` | Laundry service analysis | Service optimization |
| `analyze_service_items` | Service item tracking | Inventory management |
| `analyze_customer_revenue` | Revenue analysis | Business intelligence |
| `analyze_towel_usage` | Supply usage tracking | Cost optimization |
| `analyze_job_statistics` | Performance metrics | Operational insights |

#### Caching and Performance
| MCP Tool | Purpose | Cache Duration |
|---|---|---|
| `list_hcp_cache` | View cached responses | N/A |
| `search_hcp_cache` | Search cached data | N/A |
| `cleanup_hcp_cache` | Clear old cache | N/A |

**Cache Strategy**:
- Responses > 500KB cached for 15 minutes
- Small responses (<500KB) include data directly
- JSONPath support for complex queries
- Automatic cleanup of old cache files

## Automation Trigger Mappings

### Scheduled Automations (Cron-Based)

#### Every 4 Hours - Data Ingestion
**Dev Environment**: :10 minutes past hour (4:10, 8:10, 12:10, 16:10, 20:10, 0:10)
**Prod Environment**: :00 minutes past hour (4:00, 8:00, 12:00, 16:00, 20:00, 0:00)

**Triggered Processes**:
1. **Gmail CSV Download**: 
   - Downloads iTrip reservation CSVs
   - Creates Airtable records via MCP `create_record`
2. **Evolve Scraping**:
   - Scrapes property data
   - Updates Airtable via MCP `update_records`
3. **ICS Feed Processing**:
   - Processes 246+ calendar feeds
   - Bulk creates via MCP `create_record`

### Real-Time Automations (Webhook-Based)

#### HCP Job Status Updates
**Trigger**: HCP webhook → `/webhooks/hcp`
**Process**:
1. Webhook validation (HMAC + forwarding auth)
2. Extract job ID and new status
3. MCP `search_records` to find Airtable record
4. MCP `update_records` to sync status

#### Employee Assignment Changes
**Trigger**: HCP webhook → employee assignment
**Process**:
1. Extract job ID and employee ID
2. MCP `get_employee` to get employee name
3. MCP `update_records` to sync assignment

### Manual Trigger Mappings (Button Actions)

#### "Create Job & Sync Status" Button
**Airtable Automation**: 
```javascript
// Automation script flow
1. Validate record completeness
2. MCP create_customer (if needed)
3. MCP create_job  
4. MCP create_job_line_item
5. Update Airtable record with HCP IDs
```

#### "Add/Update Schedule" Button  
**Airtable Automation**:
```javascript
// Automation script flow
1. Extract service time from record
2. MCP reschedule_job with new times
3. Update Airtable scheduled fields
```

## Data Flow Architecture

### Inbound Data Flow
```
External Sources → CSV/API → Python Processing → Airtable MCP → Airtable
```

**Sources**:
- iTrip (Gmail OAuth CSV download)
- Evolve (Selenium scraping)
- ICS Feeds (Calendar parsing)
- Manual entry (Direct Airtable input)

### Job Creation Flow
```
Airtable Record → Button Trigger → Airtable Automation → HCP MCP → HousecallPro
```

### Status Sync Flow
```
HousecallPro → Webhook → Python Handler → Airtable MCP → Airtable
```

## Field Validation and Constraints

### Airtable Field Constraints
| Field | Type | Required | Max Length | Validation |
|---|---|---|---|---|
| Reservation UID | Single Line Text | Yes | 50 | Unique |
| Guest Name | Single Line Text | Yes | 100 | Non-empty |
| Service Date | Date | Yes | - | Valid date |
| Service Time | Single Line Text | No | 20 | Time format |
| Phone | Phone Number | No | 15 | Phone format |
| Email | Email | No | 100 | Email format |
| Service Line Custom Instructions | Long Text | No | 200 | Unicode support |

### HCP Field Constraints
| Field | Type | Required | Max Length | Validation |
|---|---|---|---|---|
| first_name | String | Yes | 50 | Non-empty |
| last_name | String | Yes | 50 | Non-empty |
| email | String | No | 100 | Email format |
| mobile_number | String | No | 15 | Phone format |
| line_item.name | String | Yes | 200 | Non-empty |
| line_item.unit_price | Number | Yes | - | > 0 |

## Error Handling and Recovery

### MCP Error Mappings
| Error Type | Source | Recovery Action |
|---|---|---|
| CustomerNotFound | HCP MCP | Create new customer |
| InvalidPermissions | HCP MCP | Check API key, retry |
| CustomerHasNoJobs | HCP MCP | Use list_jobs instead |
| RateLimitExceeded | Any MCP | Exponential backoff |
| NetworkError | Any MCP | Retry with timeout |

### Data Integrity Safeguards
1. **Duplicate Prevention**: HCP Job ID checked before creation
2. **Address Validation**: Geocoding verification
3. **Status Consistency**: Bidirectional validation
4. **Field Truncation**: Automatic trimming for HCP limits
5. **Unicode Handling**: Proper encoding for special characters

## Security and Authentication

### MCP Server Security
| Component | Authentication | Encryption |
|---|---|---|
| Airtable MCP | API Key | HTTPS/TLS |
| HCP MCP Dev | API Key | HTTPS/TLS |
| HCP MCP Prod | API Key | HTTPS/TLS |
| Webhook Handler | HMAC + Secret | HTTPS/TLS |

### Environment Isolation
- Complete credential separation
- No cross-environment data access
- Environment-specific MCP servers
- Separate log files and storage

Last Updated: 2025-06-07
Scope: Complete integration mapping
Environments: Development and Production
MCP Version: 2.2.1+